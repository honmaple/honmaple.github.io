<!DOCTYPE html>
<html lang="en">
  <head>
    <title>flask使用token进行验证</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../theme/css/main.css" type="text/css" />
  </head>
  <body id="index" class="home">
    <div id="particles-js"></div>
    <div class="wrap">
      <div class="main">
        <header id="banner" class="body">
          <h1><a href="../../..">honmaple's blog </a></h1>
          <nav><ul>
              <li><a href="http://honmaple.org">主页</a></li>
                <li ><a href="../../../category/linux/index.html">Linux</a></li>
                <li class="active"><a href="../../../category/python/index.html">Python</a></li>
                <li ><a href="../../../category/security/index.html">Security</a></li>
                <li class="dropdown">
                  <a href="../../../category/sheng-huo-sui-bi/index.html" >生活随笔</a>
                  <dl>
                      <dd><a href="../../../category/hui-yi/index.html">回忆</a></dd>
                  </dl>
                </li>
            <li class="dropdown">
              <a href="../../../archives.html">Archives</a>
              <dl>
                <dd><a href="../../../tags.html">Tags</a></dd>
                <dd><a href="../../../categories.html">Categories</a></dd>
                <dd><a href="../../../authors.html">Authors</a></dd>
              </dl>
            </li>
            <li style="float:right;margin-right:15px;">
              <form onsubmit="return dispatch()" class="search has-feedback">
                <input type="text" id="search" name="search"/>
                <i class="form-control-feedback"></i>
              </form>
            </li>
          </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
    <article>
        <header>
            <h1 class="entry-title">
                <a href="articles/2016/12/flask使用token进行登陆.html" rel="bookmark"
                   title="Permalink to flask使用token进行验证">flask使用token进行验证</a></h1>
            <hr style="margin-top: 20px;margin-bottom: 20px;border: 0;border-top: 1px solid #eee;" />
        </header>

        <div class="entry-content article-content">
<footer class="post-info">
  <abbr class="published" title="2016-12-13T00:00:00+08:00">
    二 13 十二月 2016
  </abbr>

    <address class="vcard author">
      By <a class="url fn" href="../../../author/honmaple.html">honmaple</a>
    </address>
  <p>In <a href="../../../category/python/index.html">Python</a>. </p>
<p>tags: <a href="../../../tag/flask/index.html">flask</a><a href="../../../tag/python/index.html">python</a><a href="../../../tag/token/index.html">token</a></p></footer><!-- /.post-info -->            <div id="table-of-contents"><h2>Table of Contents</h2><div id="text-table-of-contents"><ul>
<li><a href="#org-15014257229058">为什么需要用token验证</a></li>
<li><a href="#org-15014257229061">如何使用token?</a>
<ul>
<li><a href="#org-15014257229061">生成token</a></li>
<li><a href="#org-15014257229062">验证token</a></li>
<li><a href="#org-15014257229063">使用flask-login</a></li>
<li><a href="#org-15014257229064">设置csrf白名单</a></li>
</ul></li>
<li><a href="#org-15014257229064">使用脚本发表</a></li>
</ul>
</div></div>


<h1 id="org-15014257229058">为什么需要用token验证</h1>
<p>原因呢是因为写博客时已经在本地写好了，但是要发表到网站上还需要这么几步:</p>

<ul>
<li><input type="checkbox" checked="checked" />打开浏览器</li>
<li><input type="checkbox" checked="checked" />打开我的网站</li>
<li><input type="checkbox" checked="checked" />进入登陆页</li>
<li><input type="checkbox" checked="checked" />登陆</li>
<li><input type="checkbox" checked="checked" />进入后台页</li>
<li><input type="checkbox" checked="checked" />进入文章发表页</li>
<li><input type="checkbox" checked="checked" />复制粘贴</li>
<li><input type="checkbox" checked="checked" />发表
</li>
</ul>
<p>所以使用*token*验证成为必然</p>

<h1 id="org-15014257229061">如何使用token?</h1>

<h2 id="org-15014257229061">生成token</h2>
<p>使用*itsdangerous*对token进行加密
<pre class="python">
     class User(model):
         ......

         @property
         def token(self):
             config = current_app.config
             secret_key = config.setdefault('SECRET_KEY')
             salt = config.setdefault('SECURITY_PASSWORD_SALT')
             serializer = URLSafeTimedSerializer(secret_key)
             # column = self.(需要加密的字段)
             token = serializer.dumps(column, salt=salt)
             return token
</pre>
请保管好*SECRET_KEY* 和<b>SECURITY_PASSWORD_SALT</b>,不要泄露</p>

<h2 id="org-15014257229062">验证token</h2>
<pre class="python">
     class User(Model):
         ......

         @staticmethod
         def check_token(token, max_age=86400):
             config = current_app.config
             secret_key = config.setdefault('SECRET_KEY')
             salt = config.setdefault('SECURITY_PASSWORD_SALT')
             serializer = URLSafeTimedSerializer(secret_key)
             try:
                 column = serializer.loads(token, salt=salt, max_age=max_age)
             except BadSignature:
                 return False
             except SignatureExpired:
                 return False
</pre>
<ul>
<li>max-age
<p>最大过期时间</p>
</li>
</ul>
<p>如果验证成功查找*该用户*是否存在
<pre class="python">
     user = User.query.filter_by(column=column).first()
     if user is None:
         return False
     return user
</pre></p>

<p>示例:
<pre class="python">
     @staticmethod
     def check_token(token, max_age=86400):
         config = current_app.config
         secret_key = config.setdefault('SECRET_KEY')
         salt = config.setdefault('SECURITY_PASSWORD_SALT')
         serializer = URLSafeTimedSerializer(secret_key)
         try:
             username = serializer.loads(token, salt=salt, max_age=max_age)
         except BadSignature:
             return False
         except SignatureExpired:
             return False
         user = User.query.filter_by(username=username).first()
         if user is None:
             return False
         return user
</pre></p>

<h2 id="org-15014257229063">使用flask-login</h2>
<p>flask-login是flask的一个登陆扩展,自带token验证,<b>但是请一定要设</b>
<pre class="python">
    login_manager.session_protection = "basic"
</pre>
这是我在试验了n次后,读了flask-login的源码后才发现的（其实后面发现文档有写☹）</p>

<p>然后设置<b>request_loader</b>
<pre class="python">
    @login_manager.request_loader
    def user_loader_from_request(request):
        token = request.args.get('your_token')
        if token is not None:
            user = User.check_token(token)
            if user:
                return user

    return login_manager
</pre>
这是简单的从*url*中获取*token*进行验证,也可以从<b>header</b>中获取(更安全)
<pre class="python">
     token = request.headers.get('your_token')
</pre>
非常不幸的是，假设你开启了*csrf*保护,本地使用脚本验证时会报*400*错误,设置*csrf*白名单
<pre class="python">
    csrf.exempt
</pre></p>
<h2 id="org-15014257229064">设置csrf白名单</h2>

<h1 id="org-15014257229064">使用脚本发表</h1>
<p>直接给出代码
<pre class="python">
    from urllib import request
    import json

    content = '''
        ,* adssad
        ,** adasd
        ,*** adsad
        '''

    data = {
        'title': 'hello world',
        'content':content
    }
    data = json.dumps(data)
    data = bytes(data, 'utf8')
    url = 'xxxxx' + '?your_token='
    req = request.Request(url, data=data)
    req.add_header('Content-Type', 'application/json')
    req.add_header(
        'User-Agent',
        'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.107 Safari/537.36'
    )
    result = request.urlopen(req).read().decode('utf-8')
    print(result)
</pre></p>

<p>现在的步骤是:</p>
<ul>
<li><input type="checkbox" checked="checked" />复制粘贴</li>
<li><input type="checkbox" checked="checked" />发表

<p>ok,后续可能还需要将+复制粘贴+这一步也去了</p>
</li>
</ul>
<p>本篇文章就是采用这种方式发表</p>
        </div><!-- /.entry-content -->
        <div class="comments">
            <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
             var disqus_identifier = "articles/2016/12/flask使用token进行登陆.html";
             (function() {
                 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                 dsq.src = 'https://honmaple.disqus.com/embed.js';
                 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
             })();
            </script>
        </div>

    </article>
</section>
      </div>
    </div>
    <div class="footer">
      <section id="extras">
          <div class="blogroll">
            <h2>blogroll</h2>
            <ul>
                <li><a href="http://getpelican.com/">Pelican</a></li>
                <li><a href="http://python.org/">Python.org</a></li>
                <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                <li><a href="https://honmaple.com">个人博客</a></li>
            </ul>
          </div><!-- /.blogroll -->
          <div class="social">
            <h2>social</h2>
            <ul>
                <li><a href="http://honmaple.org/feeds/all.rss.xml">Atom Feed</a></li>
                <li><a href="https://github.com/honmaple">GitHub</a></li>
                <li><a href="https://twitter.com/xiyang87">Twitter</a></li>
            </ul>
          </div><!-- /.social -->
      </section><!-- /#extras -->
    </div>

<script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-88401692-2', 'auto');
 ga('send', 'pageview');

</script>
<script type="text/javascript">
    var disqus_shortname = 'honmaple';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
    <script src="https://cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
    <script type="text/javascript" src="../../../theme/js/particles.js"></script>
  </body>
</html>