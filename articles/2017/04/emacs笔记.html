<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>emacs笔记 · honmaple's blog · 风落花语风落天，花落风雨花落田.</title>
      <link href="https://honmaple.b0.upaiyun.com/static/css/lib.min.css" rel="stylesheet">
        <link href="https://honmaple.me/theme/css/style.min.css" rel="stylesheet">
  </head>
  <body>
    <div class="particles-js" id="particles-js"></div>
    <div class="scrollbar"></div>
    <div class="wrap">
      <div class="main">
<nav class="navbar navbar-default">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-header" aria-expanded="false">
      <span class="sr-only"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="https://honmaple.me">
      <img class="navbar-logo" src="https://honmaple.b0.upaiyun.com/images/header/header-logo.png" alt="楓">
    </a>
      <p class="navbar-text">—— 风落花语风落天，花落风雨花落田.</p>
  </div>
  <div class="collapse navbar-collapse" id="nav-header">
    <ul class="nav navbar-nav">
          <li class="dropdown">
            <a href="https://honmaple.me/category/life/index.html" >代码人生</a>
            <ul class="dropdown-menu">
                <li><a href="https://honmaple.me/category/coding/index.html">分享世界</a></li>
                <li><a href="https://honmaple.me/category/love/index.html">你不懂我</a></li>
                <li><a href="https://honmaple.me/category/recall/index.html">我不怪你</a></li>
            </ul>
          </li>
          <li class="active"><a href="https://honmaple.me/category/linux/index.html">字符艺术</a></li>
          <li ><a href="https://honmaple.me/category/python/index.html">人生苦短</a></li>
          <li ><a href="https://honmaple.me/category/security/index.html">极客安全</a></li>
      <li class="dropdown">
        <a href="https://honmaple.me/archives.html">文章归档</a>
        <ul class="dropdown-menu">
          <li><a href="https://honmaple.me/tags.html">标签</a></li>
          <li><a href="https://honmaple.me/categories.html">分类</a></li>
          <li><a href="https://honmaple.me/authors.html">作者</a></li>
        </ul>
      </li>
      <li><a href="https://honmaple.me/pages/about.html">关于</a></li>
    </ul>
    <form action="https://honmaple.me/search.html" class="navbar-form navbar-right" style="margin-top:10px;">
      <div class="form-group has-feedback">
        <input class="form-control input-sm" id="search" name="q" type="text" onfocus="this.placeholder='搜索'" onblur="this.placeholder=''">
        <i class="fa fa-search form-control-feedback"></i>
      </div>
    </form>
  </div>
</nav>  <article>
    <div class="entry-header">
      <h1 class="entry-title"><a href="https://honmaple.me/articles/2017/04/emacs笔记.html">emacs笔记</a></h1>
<header class="entry-info">
  <span title="Updated at 2018-11-09">
    <i class="fa fa-calendar-o"></i>
    五 21 四月 2017
  </span>
    <span class="entry-info-sep hidden-xs">|</span>
    <span class="hidden-xs">
      <i class="fa fa-user-o"></i>
      By <a href="https://honmaple.me/author/honmaple.html">honmaple</a>
    </span>
  <span class="entry-info-sep">|</span>
  <span>
    <i class="fa fa-folder-o"></i>
    In <a href="https://honmaple.me/category/linux/index.html">Linux</a>
  </span>
    <span class="entry-info-sep">|</span>
    <span>
      <i class="fa fa-bookmark-o"></i>
      0f
        <a href="https://honmaple.me/tag/linux/index.html">linux</a>
        <a href="https://honmaple.me/tag/emacs/index.html">emacs</a>
    </span>

</header>    </div>
    <hr class="entry-hr" />
    <div class="entry-content entry-article">
      <div id="table-of-contents"><h2>Table of Contents</h2><div id="text-table-of-contents"><ul>
<li><a href="#org-40574498">Evil</a>
<ul>
<li><a href="#org-85935773">粘贴替换的时候会复制替换的文本</a></li>
<li><a href="#org-37069734">自动搜索已选中的字符</a></li>
<li><a href="#org-59166669">evil-mc不忽略大小写</a></li>
</ul></li>
<li><a href="#org-24200485">Font</a>
<ul>
<li><a href="#org-28561319">设置中英文字体</a></li>
</ul></li>
<li><a href="#org-55159199">Ivy</a>
<ul>
<li><a href="#org-29787777">指定目录或文件进行搜索</a></li>
<li><a href="#org-4933710">查找当前目录以及子目录的某个文件</a></li>
<li><a href="#org-1774610">当选中单词时，swiper使用已选单词进行搜索</a></li>
</ul></li>
<li><a href="#org-46394265">File</a>
<ul>
<li><a href="#org-58556399">获取文件或目录的basename</a></li>
</ul></li>
<li><a href="#org-14204602">Elisp</a>
<ul>
<li><a href="#org-17571457">golang自动增加注释</a></li>
<li><a href="#org-19066465">增加到hook但仅调用一次</a></li>
<li><a href="#org-43484288">迭代并获取列表索引</a></li>
<li><a href="#org-4503463">深拷贝function</a></li>
</ul></li>
</ul>
</div></div>


<h2 id="org-40574498">Evil</h2>
<h3 id="org-85935773">粘贴替换的时候会复制替换的文本</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">evil-paste-after-from-0</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">evil-this-register</span> <span class="nv">?0</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">call-interactively</span> <span class="ss">&#39;evil-paste-after</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">define-key</span> <span class="nv">evil-visual-state-map</span> <span class="s">&quot;p&quot;</span> <span class="ss">&#39;evil-paste-after-from-0</span><span class="p">)</span>
</pre></div>

<h3 id="org-37069734">自动搜索已选中的字符</h3>
<p>经常使用 evil 中的 =/= 进行搜索, 但有时候想要搜索已有的字符, 在 <b>evil-visual-state</b> 下选中某个字符,按 =/= 时自动把选中的字符填入待搜索项中</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">use-package</span> <span class="nv">isearch</span>
  <span class="nb">:ensure</span> <span class="no">nil</span>
  <span class="nb">:init</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/evil-search-paste</span><span class="p">()</span>
    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">region-active-p</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">isearch-yank-string</span>
       <span class="p">(</span><span class="k">save-excursion</span>
         <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
          <span class="p">(</span><span class="nf">region-beginning</span><span class="p">)</span> <span class="p">(</span><span class="nf">1+</span> <span class="p">(</span><span class="nf">region-end</span><span class="p">)))))</span>
      <span class="p">(</span><span class="nv">deactivate-mark</span><span class="p">)))</span>
  <span class="nb">:hook</span> <span class="p">(</span><span class="nv">isearch-mode</span> <span class="o">.</span> <span class="nv">maple/evil-search-paste</span><span class="p">)</span>
  <span class="nb">:bind</span> <span class="p">(</span><span class="nb">:map</span> <span class="nv">isearch-mode-map</span>
              <span class="p">([</span><span class="nv">remap</span> <span class="nv">isearch-delete-char</span><span class="p">]</span> <span class="o">.</span> <span class="nv">isearch-del-char</span><span class="p">)))</span>
</pre></div>

<h3 id="org-59166669">evil-mc不忽略大小写</h3>
<p><b>evil-mc</b> 默认会通过<code>evil-ex-search</code>进行搜索，可以通过设置<code>(setq evil-ex-search-case 'sensitive)</code>来不忽略大小写, 但我只想在使用<b>evil-mc</b>时不忽略，其他时间忽略</p>
<div class="highlight"><pre><span></span><span class="c1">;; ignore case in evil-mc</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;evil-mc-before-cursors-created</span> <span class="p">(</span><span class="k">lambda</span><span class="p">()</span> <span class="p">(</span><span class="k">setq</span> <span class="nv">evil-ex-search-case</span> <span class="ss">&#39;sensitive</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;evil-mc-after-cursors-deleted</span> <span class="p">(</span><span class="k">lambda</span><span class="p">()</span> <span class="p">(</span><span class="k">setq</span> <span class="nv">evil-ex-search-case</span> <span class="ss">&#39;smart</span><span class="p">)))</span>
</pre></div>


<h2 id="org-24200485">Font</h2>
<h3 id="org-28561319">设置中英文字体</h3>
<div class="highlight"><pre><span></span><span class="c1">;; 中英文表格对齐</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="nv">emacs-english-font</span> <span class="s">&quot;DejaVu Sans Mono&quot;</span>
  <span class="s">&quot;The font name of English.&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="nv">emacs-cjk-font</span> <span class="s">&quot;WenQuanYi Micro Hei Mono&quot;</span>
  <span class="s">&quot;The font name for CJK.&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="nv">emacs-font-size-pair</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">15</span> <span class="o">.</span> <span class="mi">18</span><span class="p">)</span>
  <span class="s">&quot;Default font size pair for (english . chinese)&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="nv">emacs-font-size-pair-list</span>
  <span class="o">&#39;</span><span class="p">((</span> <span class="mi">5</span> <span class="o">.</span>  <span class="mi">6</span><span class="p">)</span> <span class="p">(</span><span class="mi">10</span> <span class="o">.</span> <span class="mi">12</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">13</span> <span class="o">.</span> <span class="mi">16</span><span class="p">)</span> <span class="p">(</span><span class="mi">15</span> <span class="o">.</span> <span class="mi">18</span><span class="p">)</span> <span class="p">(</span><span class="mi">17</span> <span class="o">.</span> <span class="mi">20</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">19</span> <span class="o">.</span> <span class="mi">22</span><span class="p">)</span> <span class="p">(</span><span class="mi">20</span> <span class="o">.</span> <span class="mi">24</span><span class="p">)</span> <span class="p">(</span><span class="mi">21</span> <span class="o">.</span> <span class="mi">26</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">24</span> <span class="o">.</span> <span class="mi">28</span><span class="p">)</span> <span class="p">(</span><span class="mi">26</span> <span class="o">.</span> <span class="mi">32</span><span class="p">)</span> <span class="p">(</span><span class="mi">28</span> <span class="o">.</span> <span class="mi">34</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">30</span> <span class="o">.</span> <span class="mi">36</span><span class="p">)</span> <span class="p">(</span><span class="mi">34</span> <span class="o">.</span> <span class="mi">40</span><span class="p">)</span> <span class="p">(</span><span class="mi">36</span> <span class="o">.</span> <span class="mi">44</span><span class="p">))</span>
  <span class="s">&quot;This list is used to store matching (englis . chinese) font-size.&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">font-exist-p</span> <span class="p">(</span><span class="nv">fontname</span><span class="p">)</span>
  <span class="s">&quot;Test if this font is exist or not.&quot;</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">not</span> <span class="nv">fontname</span><span class="p">)</span> <span class="p">(</span><span class="nb">string=</span> <span class="nv">fontname</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
      <span class="no">nil</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">x-list-fonts</span> <span class="nv">fontname</span><span class="p">))</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/set-font</span> <span class="p">(</span><span class="nv">english</span> <span class="nv">chinese</span> <span class="nv">size-pair</span><span class="p">)</span>
  <span class="s">&quot;Setup emacs English and Chinese font on x window-system.&quot;</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">font-exist-p</span> <span class="nv">english</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">set-frame-font</span> <span class="p">(</span><span class="nb">format</span> <span class="s">&quot;%s:pixelsize=%d&quot;</span> <span class="nv">english</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">size-pair</span><span class="p">))</span> <span class="no">t</span><span class="p">))</span>

  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">font-exist-p</span> <span class="nv">chinese</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">charset</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">kana</span> <span class="nv">han</span> <span class="nc">symbol</span> <span class="nv">cjk-misc</span> <span class="nv">bopomofo</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">set-fontset-font</span> <span class="p">(</span><span class="nv">frame-parameter</span> <span class="no">nil</span> <span class="ss">&#39;font</span><span class="p">)</span> <span class="nv">charset</span>
                          <span class="p">(</span><span class="nv">font-spec</span> <span class="ss">:family</span> <span class="nv">chinese</span> <span class="ss">:size</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">size-pair</span><span class="p">))))))</span>
<span class="c1">;; (add-hook &#39;ctbl:table-mode-hook</span>
<span class="c1">;;           (maple/set-font emacs-english-font emacs-cjk-font emacs-font-size-pair))</span>
</pre></div>

<h2 id="org-55159199">Ivy</h2>
<h3 id="org-29787777">指定目录或文件进行搜索</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/counsel-ag-file</span><span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">counsel-ag</span> <span class="no">nil</span> <span class="p">(</span><span class="nv">read-file-name</span> <span class="s">&quot;Search in file(s): &quot;</span><span class="p">)))</span>
</pre></div>


<h3 id="org-4933710">查找当前目录以及子目录的某个文件</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/counsel-find-file</span><span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">ivy-read</span> <span class="s">&quot;Find file: &quot;</span>
            <span class="p">(</span><span class="nf">mapcar</span> <span class="ss">&#39;file-relative-name</span>
                    <span class="p">(</span><span class="nv">directory-files-recursively</span> <span class="nv">default-directory</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
            <span class="nb">:matcher</span> <span class="nf">#&#39;</span><span class="nv">counsel--find-file-matcher</span>
            <span class="nb">:action</span> <span class="nf">#&#39;</span><span class="nv">counsel-find-file-action</span>
            <span class="nb">:preselect</span> <span class="p">(</span><span class="nv">counsel--preselect-file</span><span class="p">)</span>
            <span class="nb">:require-match</span> <span class="ss">&#39;confirm-after-completion</span>
            <span class="nb">:history</span> <span class="ss">&#39;file-name-history</span>
            <span class="nb">:keymap</span> <span class="nv">counsel-find-file-map</span>
            <span class="nb">:caller</span> <span class="ss">&#39;counsel-find-file</span><span class="p">))</span>
</pre></div>


<h3 id="org-1774610">当选中单词时，swiper使用已选单词进行搜索</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/ivy-search-at-point</span> <span class="p">(</span><span class="nv">func</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">region</span> <span class="p">(</span><span class="nv">region-active-p</span><span class="p">))</span>
         <span class="p">(</span><span class="nf">string</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">not</span> <span class="nv">region</span><span class="p">)</span> <span class="s">&quot;&quot;</span>
                   <span class="p">(</span><span class="nf">buffer-substring-no-properties</span>
                    <span class="p">(</span><span class="nf">region-beginning</span><span class="p">)</span> <span class="p">(</span><span class="nf">region-end</span><span class="p">))))</span>
         <span class="p">(</span><span class="nv">ivy-initial-inputs-alist</span>
          <span class="p">(</span><span class="nf">list</span> <span class="p">(</span><span class="nf">cons</span> <span class="nv">func</span> <span class="nf">string</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">when</span> <span class="nv">region</span> <span class="p">(</span><span class="nv">deactivate-mark</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">funcall</span> <span class="nv">func</span><span class="p">)))</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/swiper</span><span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">maple/ivy-search-at-point</span> <span class="ss">&#39;swiper</span><span class="p">))</span>
</pre></div>

<h2 id="org-46394265">File</h2>
<h3 id="org-58556399">获取文件或目录的basename</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/basename</span> <span class="p">(</span><span class="nv">fname</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="k">or</span> <span class="p">(</span><span class="nf">file-directory-p</span> <span class="nv">fname</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">string-match</span> <span class="s">&quot;/$&quot;</span> <span class="nv">fname</span><span class="p">))</span>
      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">dirname</span> <span class="p">(</span><span class="nf">directory-file-name</span> <span class="nv">fname</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">file-name-nondirectory</span> <span class="nv">dirname</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">file-name-nondirectory</span> <span class="nv">fname</span><span class="p">)))</span>
</pre></div>

<h2 id="org-14204602">Elisp</h2>
<h3 id="org-17571457">golang自动增加注释</h3>
<p>因为<b>flycheck</b>使用了<code>golint</code>, <b>flycheck</b>总是显示代码没有注释的警告</p>
<div class="highlight"><pre><span></span>exported method Raw should have comment or be unexported (go-golint)
</pre></div>

<p>也没找到什么方法来禁止它, 作为强迫症受不了，总不能一个一个去注释, 所以写了一个函数来自动注释整个文件的所有未注释函数:</p>

<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/go-auto-comment</span><span class="p">()</span>
  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">featurep</span> <span class="ss">&#39;imenu</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;imenu</span> <span class="no">nil</span> <span class="no">t</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">imenu-auto-rescan</span> <span class="no">t</span><span class="p">)</span>
         <span class="p">(</span><span class="nv">imenu-auto-rescan-maxout</span> <span class="p">(</span><span class="k">if</span> <span class="nv">current-prefix-arg</span>
                                       <span class="p">(</span><span class="nf">buffer-size</span><span class="p">)</span>
                                     <span class="nv">imenu-auto-rescan-maxout</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">items</span> <span class="p">(</span><span class="nv">imenu--make-index-alist</span> <span class="no">t</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">items</span> <span class="p">(</span><span class="nf">delete</span> <span class="p">(</span><span class="nf">assoc</span> <span class="s">&quot;*Rescan*&quot;</span> <span class="nv">items</span><span class="p">)</span> <span class="nv">items</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">cl-mapcan</span>
     <span class="p">(</span><span class="nb">lambda</span><span class="p">(</span><span class="nv">item</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">cl-mapcan</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">string=</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">item</span><span class="p">)</span> <span class="s">&quot;func&quot;</span><span class="p">)</span>
            <span class="ss">&#39;maple/go-func-comment</span>
          <span class="ss">&#39;maple/go-type-comment</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">cdr</span> <span class="nv">item</span><span class="p">)))</span>
     <span class="nv">items</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/go-add-comment</span><span class="p">(</span><span class="nv">func</span> <span class="nf">point</span><span class="p">)</span>
  <span class="p">(</span><span class="k">save-excursion</span>
    <span class="p">(</span><span class="nf">goto-char</span> <span class="nf">point</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">forward-line</span> <span class="mi">-1</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">looking-at</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&quot;// &quot;</span> <span class="nv">func</span><span class="p">)))</span>
      <span class="p">(</span><span class="nf">end-of-line</span><span class="p">)</span> <span class="p">(</span><span class="nv">newline-and-indent</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&quot;// &quot;</span> <span class="nv">func</span> <span class="s">&quot; ..&quot;</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/go-func-comment</span><span class="p">(</span><span class="nv">f</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">func</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">f</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nv">string-prefix-p</span> <span class="s">&quot;(&quot;</span> <span class="nv">func</span><span class="p">)</span>
             <span class="p">(</span><span class="nf">string-match</span> <span class="s">&quot;[)] \\(.*\\)[(]\\(.*\\)[)]\\(.*\\)$&quot;</span> <span class="nv">func</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">maple/go-add-comment</span> <span class="p">(</span><span class="nv">match-string</span> <span class="mi">1</span> <span class="nv">func</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">f</span><span class="p">))</span>
      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">string-match</span> <span class="s">&quot;\\(.*\\)[(]\\(.*\\)[)]\\(.*\\)$&quot;</span> <span class="nv">func</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">maple/go-add-comment</span> <span class="p">(</span><span class="nv">match-string</span> <span class="mi">1</span> <span class="nv">func</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">f</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">maple/go-add-comment</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">f</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">f</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">maple/go-type-comment</span><span class="p">(</span><span class="nv">f</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">maple/go-add-comment</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">f</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">f</span><span class="p">)))</span>
</pre></div>


<p>相关配置将持续更新: <a href="https://github.com/honmaple/dotfiles/blob/master/emacs.d/lisp/init-go.el">init-go.el</a></p>

<h3 id="org-19066465">增加到hook但仅调用一次</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span> <span class="nv">maple/add-hook-once</span> <span class="p">(</span><span class="nv">hook</span> <span class="nv">f</span> <span class="kp">&amp;optional</span> <span class="nf">append</span> <span class="nv">local</span><span class="p">)</span>
  <span class="s">&quot;Like `add-hook`, remove after call with HOOK F &amp;OPTIONAL APPEND LOCAL.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">func</span> <span class="p">(</span><span class="nf">intern</span> <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;maple/run-once-%s&quot;</span>
                              <span class="p">(</span><span class="nf">symbol-name</span> <span class="nv">f</span><span class="p">)))))</span>
    <span class="o">`</span><span class="p">(</span><span class="k">progn</span>
       <span class="p">(</span><span class="nb">defun</span> <span class="o">,</span><span class="nv">func</span> <span class="p">()</span>
         <span class="p">(</span><span class="nv">remove-hook</span> <span class="ss">&#39;,hook</span> <span class="ss">&#39;,func</span> <span class="o">,</span><span class="nv">local</span><span class="p">)</span>
         <span class="p">(</span><span class="nf">funcall</span> <span class="ss">&#39;,f</span><span class="p">))</span>
       <span class="p">(</span><span class="nv">add-hook</span> <span class="ss">&#39;,hook</span> <span class="ss">&#39;,func</span> <span class="o">,</span><span class="nf">append</span> <span class="o">,</span><span class="nv">local</span><span class="p">))))</span>
</pre></div>

<h3 id="org-43484288">迭代并获取列表索引</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span> <span class="nv">maple/dolist</span> <span class="p">(</span><span class="nv">spec</span> <span class="kp">&amp;rest</span> <span class="nv">body</span><span class="p">)</span>
 <span class="s">&quot;Like dolist but get INDEX, SPEC &amp;REST BODY.&quot;</span>
 <span class="p">(</span><span class="nb">declare</span> <span class="p">(</span><span class="nv">indent</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nv">debug</span> <span class="p">((</span><span class="nf">symbolp</span> <span class="nv">form</span> <span class="kp">&amp;optional</span> <span class="nv">form</span><span class="p">)</span> <span class="nv">body</span><span class="p">)))</span>
 <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">num</span> <span class="mi">0</span><span class="p">))</span>
     <span class="p">(</span><span class="nb">dolist</span> <span class="o">,</span><span class="p">(</span><span class="nf">cdr</span> <span class="nv">spec</span><span class="p">)</span>
     <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="o">,</span><span class="p">(</span><span class="nf">car</span> <span class="nv">spec</span><span class="p">)</span> <span class="nv">num</span><span class="p">))</span>
         <span class="o">,@</span><span class="nv">body</span>
         <span class="p">(</span><span class="k">setq</span> <span class="nv">num</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">num</span> <span class="mi">1</span><span class="p">))))))</span>
</pre></div>

<p>这样就可以使用</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">maple/dolist</span> <span class="p">(</span><span class="nv">index</span> <span class="nv">item</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;aaa&quot;</span> <span class="s">&quot;bbb&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nf">print</span> <span class="nv">index</span><span class="p">))</span>
</pre></div>

<h3 id="org-4503463">深拷贝function</h3>
<p>https://www.gnu.org/software/emacs/manual/html_node/elisp/Function-Cells.html</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">fset</span> <span class="ss">&#39;maple/put-text-property</span> <span class="p">(</span><span class="nf">symbol-function</span> <span class="ss">&#39;put-text-property</span><span class="p">))</span>
</pre></div>

    </div>
    <hr class="entry-hr" />
    <ul class="entry-pager">
        <li class="previous">
          <a href="https://honmaple.me/articles/2017/05/晒晒我的Linux及桌面.html" title="Previous article: 晒晒我的Linux及桌面">
            <i class="fa fa-chevron-left"></i>
            晒晒我的Linux及桌面
          </a>
        </li>
        <li class="next">
          <a href="https://honmaple.me/articles/2017/04/emacs实现智能注释.html" title="Next article: emacs实现智能注释">
            emacs实现智能注释
            <i class="fa fa-chevron-right"></i>
          </a>
        </li>
    </ul>
      <div class="comments">
        <div class="text-center">
          <a class="btn entry-read-more entry-comment">加载评论</a>
        </div>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
         var disqus_identifier = "articles/2017/04/emacs笔记.html";
        </script>
      </div>
  </article>
      </div>
    </div>
<div class="footer">
  <ul class="list-inline entry-social">
    <li><a class="entry-theme" title="Moon"><i class="fa fa-moon-o"></i></a></li>
      <li ><a href="https://honmaple.me/pages/music.html" title="Music"><i class="fa fa-music"></i></a></li>
      <li class="hidden-xs"><a href="https://honmaple.me/feeds/atom.xml" title="Feed"><i class="fa fa-feed"></i></a></li>
      <li ><a href="https://github.com/honmaple" title="GitHub"><i class="fa fa-github"></i></a></li>
      <li ><a href="https://honmaple.me/pages/travel.html" title="Camera"><i class="fa fa-camera"></i></a></li>
      <li ><a href="https://honmaple.me/pages/contact.html" title="Envelope"><i class="fa fa-envelope"></i></a></li>
  </ul>
  <ul class="list-inline copyright">
    <li class="hidden-xs">© 2015-2019 honmaple</li>
    <li class="hidden-xs">·</li>
    <li>
          <a href="https://honmaple.me/pages/friends.html">友链</a>
          <span> | </span>
          <a href="https://honmaple.me/pages/contact.html">联系</a>
          <span> | </span>
          <a href="https://honmaple.me/pages/project.html">项目</a>
          <span> | </span>
          <a href="https://honmaple.me/pages/timeline.html">时间轴</a>
    </li>
  </ul>
</div>    <div class="back-to-top back-to-top-on">
      <i class="fa fa-hand-o-up" title="back to top"></i>
    </div>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-88401692-2"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'UA-88401692-2');
  </script>
      <script src="https://honmaple.b0.upaiyun.com/static/js/lib.min.js"></script>
        <script src="https://honmaple.me/theme/js/script.min.js"></script>
      <script src="https://honmaple.b0.upaiyun.com/static/js/instantclick.min.js" data-no-instant></script>
      <script data-no-instant>
       InstantClick.on('change', function() {
           if (typeof ga !== 'undefined') {
               ga('send', 'pageview', location.pathname + location.search);
           }
       });
       InstantClick.init(60);
      </script>
  </body>
</html>