<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"><channel><title>HonMaple's Blog</title><link>http://honmaple.org/</link><description></description><lastBuildDate>Sat, 05 Mar 2016 00:00:00 +0800</lastBuildDate><item><title>flask-sqlalchemy使用</title><link>http://honmaple.org/articles/2016/03/flask-sqlalchemy%E4%BD%BF%E7%94%A8.html</link><description>&lt;p&gt;简单的例子&lt;a href="http://flask-sqlalchemy.pocoo.org/2.1/quickstart/"&gt;这里&lt;/a&gt;已经有了&lt;br /&gt;
&lt;a href="http://www.pythondoc.com/flask-sqlalchemy/index.html"&gt;中文&lt;/a&gt;
这里记录一下平时我遇到的一些问题  &lt;/p&gt;
&lt;h4&gt;一对多&lt;/h4&gt;
&lt;p&gt;需求:一个问题对应多个回复&lt;br /&gt;
下面给出代码(字段不完整)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="n"&gt;Questions&lt;/span&gt;(&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Model&lt;/span&gt;):
    &lt;span class="n"&gt;__tablename__&lt;/span&gt; = &lt;span class="s"&gt;&amp;#39;questions&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;id&lt;/span&gt; = &lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Column&lt;/span&gt;(&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Integer&lt;/span&gt;, &lt;span class="n"&gt;primary_key&lt;/span&gt;=&lt;span class="nb"&gt;True&lt;/span&gt;)
    &lt;span class="n"&gt;title&lt;/span&gt; = &lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Column&lt;/span&gt;(&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;String&lt;/span&gt;(&lt;span class="mi"&gt;50&lt;/span&gt;), &lt;span class="n"&gt;nullable&lt;/span&gt;=&lt;span class="nb"&gt;False&lt;/span&gt;)
    &lt;span class="n"&gt;content&lt;/span&gt; = &lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Column&lt;/span&gt;(&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Text&lt;/span&gt;, &lt;span class="n"&gt;nullable&lt;/span&gt;=&lt;span class="nb"&gt;False&lt;/span&gt;)

    &lt;span class="n"&gt;def&lt;/span&gt; &lt;span class="n"&gt;__init__&lt;/span&gt;(&lt;span class="k"&gt;self&lt;/span&gt;,&lt;span class="n"&gt;title&lt;/span&gt;,&lt;span class="n"&gt;content&lt;/span&gt;):
        &lt;span class="k"&gt;self&lt;/span&gt;.&lt;span class="n"&gt;title&lt;/span&gt; = &lt;span class="n"&gt;title&lt;/span&gt;
        &lt;span class="k"&gt;self&lt;/span&gt;.&lt;span class="n"&gt;content&lt;/span&gt; = &lt;span class="n"&gt;content&lt;/span&gt;

    &lt;span class="n"&gt;def&lt;/span&gt; &lt;span class="n"&gt;__repr__&lt;/span&gt;(&lt;span class="k"&gt;self&lt;/span&gt;):
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;lt;Questions %r&amp;gt;&amp;quot;&lt;/span&gt; % &lt;span class="k"&gt;self&lt;/span&gt;.&lt;span class="n"&gt;title&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="n"&gt;Replies&lt;/span&gt;(&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Model&lt;/span&gt;):
    &lt;span class="n"&gt;__tablename__&lt;/span&gt; = &lt;span class="s"&gt;&amp;#39;replies&amp;#39;&lt;/span&gt;
    &lt;span class="n"&gt;id&lt;/span&gt; = &lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Column&lt;/span&gt;(&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Integer&lt;/span&gt;, &lt;span class="n"&gt;primary_key&lt;/span&gt;=&lt;span class="nb"&gt;True&lt;/span&gt;)
    &lt;span class="n"&gt;content&lt;/span&gt; = &lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Column&lt;/span&gt;(&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Text&lt;/span&gt;, &lt;span class="n"&gt;nullable&lt;/span&gt;=&lt;span class="nb"&gt;False&lt;/span&gt;)
    &lt;span class="n"&gt;question_id&lt;/span&gt; = &lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Column&lt;/span&gt;(&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;Integer&lt;/span&gt;, &lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;ForeignKey&lt;/span&gt;(&lt;span class="s"&gt;&amp;#39;questions.id&amp;#39;&lt;/span&gt;,
                                                      &lt;span class="n"&gt;ondelete&lt;/span&gt;=&lt;span class="s"&gt;&amp;quot;CASCADE&amp;quot;&lt;/span&gt;))
    &lt;span class="n"&gt;replies&lt;/span&gt; = &lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;relationship&lt;/span&gt;(&lt;span class="s"&gt;&amp;#39;Questions&amp;#39;&lt;/span&gt;,
                              &lt;span class="n"&gt;backref&lt;/span&gt;=&lt;span class="n"&gt;db&lt;/span&gt;.&lt;span class="n"&gt;backref&lt;/span&gt;(&lt;span class="s"&gt;&amp;#39;replies&amp;#39;&lt;/span&gt;,
                                                 &lt;span class="n"&gt;cascade&lt;/span&gt;=&lt;span class="s"&gt;&amp;#39;all,delete-orphan&amp;#39;&lt;/span&gt;,
                                                 &lt;span class="nb"&gt;lazy&lt;/span&gt;=&lt;span class="s"&gt;&amp;#39;dynamic&amp;#39;&lt;/span&gt;,
                                                 &lt;span class="n"&gt;order_by&lt;/span&gt;=&lt;span class="s"&gt;&amp;#39;Replies.time&amp;#39;&lt;/span&gt;)
                              )

    &lt;span class="n"&gt;def&lt;/span&gt; &lt;span class="n"&gt;__init__&lt;/span&gt;(&lt;span class="k"&gt;self&lt;/span&gt;, &lt;span class="n"&gt;content&lt;/span&gt;):
        &lt;span class="k"&gt;self&lt;/span&gt;.&lt;span class="n"&gt;content&lt;/span&gt; = &lt;span class="n"&gt;content&lt;/span&gt;

    &lt;span class="n"&gt;def&lt;/span&gt; &lt;span class="n"&gt;__repr__&lt;/span&gt;(&lt;span class="k"&gt;self&lt;/span&gt;):
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s"&gt;&amp;quot;&amp;lt;Replies %r&amp;gt;&amp;quot;&lt;/span&gt; % &lt;span class="k"&gt;self&lt;/span&gt;.&lt;span class="n"&gt;content&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;会发现这样的两行(虽然实际上有好几行)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    question_id = db.Column(db.Integer, db.ForeignKey(&amp;#39;questions.id&amp;#39;,
                                                      ondelete=&amp;quot;CASCADE&amp;quot;))
    replies = db.relationship(&amp;#39;Questions&amp;#39;,
                              backref=db.backref(&amp;#39;replies&amp;#39;,
                                                 cascade=&amp;#39;all,delete-orphan&amp;#39;,
                                                 lazy=&amp;#39;dynamic&amp;#39;,
                                                 order_by=&amp;#39;Replies.time&amp;#39;)
                              )
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;question_id为外键,关联着questions这个数据表&lt;br /&gt;
replies这一行我习惯用反代,也就是backref=db.backref&lt;br /&gt;
&lt;strong&gt;调用&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;question = Questions.query.filter_by(id=1).first()
print(question.replies)  # 输出该问题的回复
print(question.replies.content) # 错误
for reply in question.replies:
    print(reply.content)  # 正确
reply = Replies.query.filter_by(id=1).first()
print(reply.question_id) # 输出该回复的所属问题
print(reply.question_id.title)
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;级联删除&lt;/h4&gt;
&lt;p&gt;也就是删除一个问题，也会将该问题下的所有回复删除,而删除问题下的回复将不会影响到具体问题&lt;br /&gt;
具体请google sqlalchemy cascade&lt;br /&gt;
经过测试,上面代码可级联删除回复,而不是将外键置空&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">2016-03-05 00:40:08.696626</dc:creator><pubDate>Sat, 05 Mar 2016 00:00:00 +0800</pubDate><guid isPermaLink="false">tag:honmaple.org,2016-03-05:articles/2016/03/flask-sqlalchemy使用.html</guid><category>flask</category><category>sqlalchemy</category></item></channel></rss>