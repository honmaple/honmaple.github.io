<!DOCTYPE html>
<html lang="en">
<head>
        <title>HonMaple's Blog - ssl</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../../theme/css/main.css" type="text/css" />
        <link rel="stylesheet" href="../../theme/css/pygments/solarizeddark.css" type="text/css"/>
   

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../css/ie.css"/>
                <script src="../../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
<a href="http://github.com/honmaple/honmaple.github.io">
<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
</a>
        <header id="banner" class="body">
                <h1><a href="../..">HonMaple's Blog </a></h1>
                <nav><ul>
                <li><a href="../..">主页</a></li>
                    <li ><a href="../../category/linux.html">linux</a></li>
                    <li ><a href="../../category/python.html">Python</a></li>
                <li> <a href="../../archives/">Archives</a></li>
                    <li><a href="../../pages/guan-yu-wo/">关于我</a></li>
                </ul></nav>
        </header><!-- /#banner -->
        
        

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../../articles/2015/12/为网站启用https.html">为网站启用https并增加ssl证书</a></h1> 
<footer class="post-info">
        <abbr class="published" title="2015-12-25T00:00:00+01:00">
                五 25 十二月 2015
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="../../author/honmaple.html">honmaple</a>
        </address>
<p>In <a href="../../category/linux.html">linux</a>. </p>
<p>tags: <a href="../../tag/seo/">[seo</a><a href="../../tag/web/">web</a><a href="../../tag/ssl/">ssl</a><a href="../../tag/nginx/">nginx]</a></p></footer><!-- /.post-info --><h2>HTTPS和HTTP的区别</h2>
<p>超文本传输协议HTTP协议被用于在Web浏览器和网站服务器之间传递信息。HTTP协议以明文方式发送内容，不提供任何方式的数据加密，如果攻击者截取了Web浏览器和网站服务器之间的传输报文，就可以直接读懂其中的信息，因此HTTP协议不适合传输一些敏感信息，比如信用卡号、密码等。
为了解决HTTP协议的这一缺陷，需要使用另一种协议：安全套接字层超文本传输协议HTTPS。为了数据传输的安全，HTTPS在HTTP的基础上加入了SSL协议，SSL依靠证书来验证服务器的身份，并为浏览器和服务器之间的通信加密。
HTTPS和HTTP的区别主要为以下四点：
+ https协议需要到ca申请证书，一般免费证书很少，需要交费。
+ http是超文本传输协议，信息是明文传输，https 则是具有安全性的ssl加密传输协议。
+ http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。
+ http的连接很简单，是无状态的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议安全。</p>
<h2>申请ssl证书</h2>
<p>对于像我这样的穷学生或者不希望花钱的同学可以使用<a href="https://www.startssl.com/">startssl免费ssl证书</a><br />
当然如果可以，最好购买ssl证书,安全性上更有保障</p>
<p>对于怎么申请startssl免费证书这里不多说，网上很多教程，其中有几点是我在申请中遇到的问题，希望对大家有所帮助<br />
+ 在进行域名验证时不论如何startssl<strong>搜索不到我的域名注册邮箱</strong>,我已将whois保护关闭后还是一样<br />
<strong>解决办法</strong>：一个不是办法的办法，因为我在qq邮箱使用了域名邮箱,所以我将域名邮箱管理员admin@honmaple.com
更改为postmaster@honmaple.com,然后发送验证邮件到该邮箱对域名进行验证</p>
<ul>
<li>
<p><strong>如何导出公钥</strong><br />
如果申请成功，在Tool Box点击Certificate List,Action中选择Retrieve导出zip包到本地,
在本地解压就会发现里面有对应服务器类型的crt证书</p>
</li>
<li>
<p><strong>如何导出私钥</strong><br />
在申请过程中保存了一个.key文件，这个文件就可以作为私钥(请妥善保管)</p>
</li>
</ul>
<blockquote>
<p>如果在申请中对私钥设置了密码,每次重启ngnix都要输入密码,如果不想每次输入密码,
在startssl的Tool Box的Decrypt Private Key中填入保存的私钥以及私钥密码,对私钥进行解密,
将解密后的字符串保存为.key文件</p>
</blockquote>
<h2>关于nginx配置</h2>
<p>在/etc/nginx/conf.d/ssl.conf中添加</p>
<div class="highlight"><pre><span></span><span class="nt">server</span> <span class="p">{</span>
     <span class="n">listen</span>       <span class="m">443</span> <span class="n">ssl</span><span class="p">;</span>
     <span class="n">server_name</span>  <span class="n">honmaple</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
     <span class="err">#请更改成你的文件地址</span>
     <span class="n">ssl_certificate</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="m">1</span><span class="n">_honmaple</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">pem</span><span class="p">;</span>
     <span class="n">ssl_certificate_key</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="m">1</span><span class="n">_honmaple</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">key</span><span class="p">;</span>

     <span class="n">ssl_session_cache</span> <span class="n">shared</span><span class="o">:</span><span class="n">SSL</span><span class="o">:</span><span class="m">1</span><span class="n">m</span><span class="p">;</span>
     <span class="n">ssl_session_timeout</span> <span class="m">5</span><span class="n">m</span><span class="p">;</span>
     <span class="err">#下面这些请根据实际更改</span><span class="o">,</span><span class="err">我的是</span><span class="n">flask</span><span class="o">+</span><span class="n">nginx</span>
     <span class="n">location</span> <span class="o">/</span> <span class="err">{</span>
                        <span class="err">#</span> <span class="n">Pass</span> <span class="n">the</span> <span class="n">request</span> <span class="n">to</span> <span class="n">Gunicorn</span>
                <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">://</span><span class="m">127</span><span class="o">.</span><span class="m">0</span><span class="o">.</span><span class="m">0</span><span class="o">.</span><span class="m">1</span><span class="o">:</span><span class="m">8000</span><span class="p">;</span>
                <span class="n">proxy_redirect</span>     <span class="n">off</span><span class="p">;</span>

                <span class="err">#</span> <span class="n">Set</span> <span class="n">some</span> <span class="n">HTTP</span> <span class="n">headers</span> <span class="n">so</span> <span class="n">that</span> <span class="n">our</span> <span class="n">app</span> <span class="n">knows</span> <span class="n">where</span> <span class="n">the</span>
                <span class="err">#</span> <span class="n">request</span> <span class="n">really</span> <span class="n">came</span> <span class="n">from</span>
                <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="err">$</span><span class="n">host</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="err">$</span><span class="n">remote_addr</span><span class="p">;</span>
                <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="err">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="p">}</span>
<span class="err">}</span>
</pre></div>


<p><strong>注意:</strong>
我不知道是我的原因还是其他,启动ngnix时总报错</p>
<div class="highlight"><pre><span></span>SSL_CTX_use_PrivateKey_file(&quot;/root/ssl/1_honmaple.com.key&quot;) 
failed (SSL: error:0D07207B:asn1 encoding routines:ASN1_get_object:
header too long error:0D068066:asn1 encoding routines:ASN1_CHECK_TLEN:bad object 
header error:0D07803A:asn1 encoding routines:ASN1_ITEM_EX_D2I:nested asn1 error:
Type=PKCS8_PRIV_KEY_INFO error:2306A065:PKCS12 routines:PKCS12_item_decrypt_d2i:
decode error error:0907B00D:PEM routines:PEM_READ_BIO_PRIVATEKEY:ASN1 lib error:
140B0009:SSL routines:SSL_CTX_use_PrivateKey_file:PEM lib)
</pre></div>


<p>所以我将.crt文件改成.pem,后面我发现还是报错，我将公钥里的  </p>
<div class="highlight"><pre><span></span>-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
</pre></div>


<p>之间的空行去除</p>
<blockquote>
<p>如果还是报错，请将.key文件解密</p>
</blockquote>
<h2>其他配置</h2>
<p>如果要全站启用https,并将http定向到https,可以这样</p>
<div class="highlight"><pre><span></span><span class="nt">server</span> <span class="p">{</span>
    <span class="n">listen</span> <span class="m">80</span> <span class="p">;</span>
    <span class="n">server_name</span> <span class="n">honmaple</span><span class="o">.</span><span class="n">com</span><span class="p">;</span>
    <span class="n">rewrite</span> <span class="o">^/</span><span class="p">(</span><span class="o">.*</span><span class="p">)</span> <span class="n">https</span><span class="o">://</span><span class="n">honmaple</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="err">$</span><span class="m">1</span> <span class="n">permanent</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>记得更改成自己的域名</p>
<p>ok,就这样</p><p>There are <a href="../../articles/2015/12/为网站启用https.html#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="https://honmaple.com">个人博客</a></li>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            
                            <li><a href="https://github.com/honmaple">GitHub</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">

        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'honmaple';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>